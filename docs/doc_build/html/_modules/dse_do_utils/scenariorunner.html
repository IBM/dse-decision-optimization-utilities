

<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dse_do_utils.scenariorunner &#8212; DSE DO Utils 0.5.5.1b0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bizstyle.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">DSE DO Utils 0.5.5.1b0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../dse_do_utils.html" accesskey="U">dse_do_utils</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">dse_do_utils.scenariorunner</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for dse_do_utils.scenariorunner</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright IBM All Rights Reserved.</span>
<span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">dse_do_utils</span> <span class="kn">import</span> <span class="n">ScenarioManager</span><span class="p">,</span> <span class="n">OptimizationEngine</span>
<span class="kn">from</span> <span class="nn">dse_do_utils.datamanager</span> <span class="kn">import</span> <span class="n">Inputs</span><span class="p">,</span> <span class="n">Outputs</span><span class="p">,</span> <span class="n">DataManager</span>
<span class="kn">from</span> <span class="nn">dse_do_utils.scenariodbmanager</span> <span class="kn">import</span> <span class="n">ScenarioDbManager</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">getLogger</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">List</span>


<div class="viewcode-block" id="ScenarioConfig"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioConfig">[docs]</a><span class="nd">@dataclass</span>  <span class="c1"># (frozen=True)</span>
<span class="k">class</span> <span class="nc">ScenarioConfig</span><span class="p">:</span>
    <span class="n">scenario_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Scenario_x&#39;</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Dict of parameters to override. Uses same names as in Parameters data table.</span></div>

<div class="viewcode-block" id="RunConfig"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.RunConfig">[docs]</a><span class="nd">@dataclass</span>  <span class="c1"># (frozen=True)</span>
<span class="k">class</span> <span class="nc">RunConfig</span><span class="p">:</span>
    <span class="n">insert_inputs_in_db</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">insert_outputs_in_db</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">new_schema</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">insert_in_do</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">write_output_to_excel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">enable_data_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">enable_data_check_outputs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">data_check_bulk_insert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># False implies row-by-row</span>
    <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;DEBUG&#39;</span>  <span class="c1"># &#39;DEBUG&#39;</span>
    <span class="n">export_lp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">export_sav</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">export_lp_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">do_model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">template_scenario_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># &#39;TemplateScenario&#39;</span></div>


<div class="viewcode-block" id="ScenarioGenerator"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioGenerator">[docs]</a><span class="k">class</span> <span class="nc">ScenarioGenerator</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Generates a variation of a scenario, i.e. `inputs` dataset, driven by a ScenarioConfig.</span>
<span class="sd">    To be subclassed.</span>
<span class="sd">    This base class implements overrides of the Parameter table.</span>
<span class="sd">    The ScenarioGenerator is typically used in the context of a ScenarioRunner.</span>

<span class="sd">    Usage::</span>

<span class="sd">        class MyScenarioGenerator(ScenarioGenerator):</span>
<span class="sd">            def generate_scenario(self):</span>
<span class="sd">                new_inputs = super().generate_scenario()</span>
<span class="sd">                new_inputs[&#39;MyTable1&#39;] = self.generate_my_table1().reset_index()</span>
<span class="sd">                new_inputs[&#39;MyTable2&#39;] = self.generate_my_table2().reset_index()</span>
<span class="sd">                return new_inputs</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">inputs</span><span class="p">:</span> <span class="n">Inputs</span><span class="p">,</span>
                 <span class="n">scenario_config</span><span class="p">:</span> <span class="n">ScenarioConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">:</span> <span class="n">Logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span> <span class="n">Inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Only copy of dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scenario_config</span><span class="p">:</span> <span class="n">ScenarioConfig</span> <span class="o">=</span> <span class="n">scenario_config</span>

<div class="viewcode-block" id="ScenarioGenerator.generate_scenario"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioGenerator.generate_scenario">[docs]</a>    <span class="k">def</span> <span class="nf">generate_scenario</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a variation of the base_inputs. To be overridden.</span>
<span class="sd">        This default implementation changes the Parameter table based on the overrides in the ScenarioConfig.parameters.</span>

<span class="sd">        Usage::</span>

<span class="sd">            def generate_scenario(self):</span>
<span class="sd">                new_inputs = super().generate_scenario()</span>
<span class="sd">                new_inputs[&#39;MyTable&#39;] = self.generate_my_table().reset_index()</span>
<span class="sd">                return new_inputs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>
        <span class="n">new_inputs</span><span class="p">[</span><span class="s1">&#39;Parameter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new_inputs</span></div>

<div class="viewcode-block" id="ScenarioGenerator.get_parameters"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioGenerator.get_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Applies overrides to the Parameter table based on the ScenarioConfig.parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_config</span><span class="o">.</span><span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Parameter&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;Parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;param&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_config</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">param</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">df</span></div></div>


<div class="viewcode-block" id="ScenarioRunner"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioRunner">[docs]</a><span class="k">class</span> <span class="nc">ScenarioRunner</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO: remove local_root, local_platform, replace by data_directory? (It seems to be working fine though)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">scenario_db_manager</span><span class="p">:</span> <span class="n">ScenarioDbManager</span><span class="p">,</span>
                 <span class="n">optimization_engine_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">OptimizationEngine</span><span class="p">],</span>
                 <span class="n">data_manager_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">DataManager</span><span class="p">],</span>
                 <span class="n">scenario_db_manager_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">ScenarioDbManager</span><span class="p">],</span>  <span class="c1"># For the SQLite data check</span>
                 <span class="n">scenario_generator_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">ScenarioGenerator</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">do_model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;my_model&#39;</span><span class="p">,</span>
                 <span class="n">schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="c1"># use_scenario_db: bool = True,</span>
                 <span class="n">local_root</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">local_platform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">data_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scenario_db_manager</span><span class="p">:</span> <span class="n">ScenarioDbManager</span> <span class="o">=</span> <span class="n">scenario_db_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_engine_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">OptimizationEngine</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimization_engine_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_manager_class</span> <span class="o">=</span> <span class="n">data_manager_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scenario_db_manager_class</span> <span class="o">=</span> <span class="n">scenario_db_manager_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scenario_generator_class</span> <span class="o">=</span> <span class="n">scenario_generator_class</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_engine</span><span class="p">:</span> <span class="n">OptimizationEngine</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># To be set in run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="p">:</span> <span class="n">DataManager</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># To be set in run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlite_scenario_db_manager</span><span class="p">:</span> <span class="n">ScenarioDbManager</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># To be set in run.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">:</span> <span class="n">Logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">do_model_name</span>
        <span class="c1"># self.use_scenario_db: bool = use_scenario_db  # TODO: VT20220906: remove, doesn&#39;t seem to be used?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_root</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_platform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_platform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_directory</span>

<div class="viewcode-block" id="ScenarioRunner.run_once"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioRunner.run_once">[docs]</a>    <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">scenario_config</span><span class="p">:</span> <span class="n">ScenarioConfig</span><span class="p">,</span>
                 <span class="n">run_config</span><span class="p">:</span> <span class="n">RunConfig</span><span class="p">,</span>
                 <span class="n">base_inputs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Inputs</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">excel_file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">run_config</span><span class="o">.</span><span class="n">new_schema</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_new_db_schema</span><span class="p">()</span>
        <span class="n">base_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_base_inputs</span><span class="p">(</span><span class="n">excel_file_name</span><span class="o">=</span><span class="n">excel_file_name</span><span class="p">,</span> <span class="n">base_inputs</span><span class="o">=</span><span class="n">base_inputs</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_once</span><span class="p">(</span><span class="n">scenario_config</span><span class="p">,</span> <span class="n">run_config</span><span class="p">,</span> <span class="n">base_inputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span></div>

<div class="viewcode-block" id="ScenarioRunner.run_multiple"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioRunner.run_multiple">[docs]</a>    <span class="k">def</span> <span class="nf">run_multiple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">scenario_configs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ScenarioConfig</span><span class="p">],</span>
                     <span class="n">run_config</span><span class="p">:</span> <span class="n">RunConfig</span><span class="p">,</span>
                     <span class="n">base_inputs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Inputs</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">excel_file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Only once create schema and/or load data from Excel.</span>
<span class="sd">        Then it will run all scenario_configs, each time applying the ScenarioGenerator on the base inputs.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">run_config</span><span class="o">.</span><span class="n">new_schema</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_new_db_schema</span><span class="p">()</span>
        <span class="n">base_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_base_inputs</span><span class="p">(</span><span class="n">excel_file_name</span><span class="o">=</span><span class="n">excel_file_name</span><span class="p">,</span> <span class="n">base_inputs</span><span class="o">=</span><span class="n">base_inputs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">scenario_config</span> <span class="ow">in</span> <span class="n">scenario_configs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_once</span><span class="p">(</span><span class="n">scenario_config</span><span class="p">,</span> <span class="n">run_config</span><span class="p">,</span> <span class="n">base_inputs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_run_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">scenario_config</span><span class="p">:</span> <span class="n">ScenarioConfig</span><span class="p">,</span>
                 <span class="n">run_config</span><span class="p">:</span> <span class="n">RunConfig</span><span class="p">,</span>
                 <span class="n">base_inputs</span><span class="p">:</span> <span class="n">Inputs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Outputs</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param scenario_config:</span>
<span class="sd">        :param run_config:</span>
<span class="sd">        :param base_inputs:</span>
<span class="sd">        :param excel_filepath</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">scenario_name</span> <span class="o">=</span> <span class="n">scenario_config</span><span class="o">.</span><span class="n">scenario_name</span>

        <span class="c1"># # Load base inputs</span>
        <span class="c1"># if excel_file_name and not base_inputs:</span>
        <span class="c1">#     self._logger.info(&#39;Loading data from the excel file&#39;)</span>
        <span class="c1">#     inputs = self.load_input_data_from_excel(excel_file_name)</span>
        <span class="c1"># elif not excel_file_name and base_inputs:</span>
        <span class="c1">#     inputs = base_inputs</span>
        <span class="c1"># else:</span>
        <span class="c1">#     raise ValueError(</span>
        <span class="c1">#         &#39;Either base_inputs or excel_file_name should be provided.&#39;)</span>

        <span class="c1"># Generate scenario</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generating scenario </span><span class="si">{</span><span class="n">scenario_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_scenario</span><span class="p">(</span><span class="n">base_inputs</span><span class="p">,</span> <span class="n">scenario_config</span><span class="p">)</span>

        <span class="c1"># Data check</span>
        <span class="k">if</span> <span class="n">run_config</span><span class="o">.</span><span class="n">enable_data_check</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_check_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">scenario_name</span> <span class="o">=</span> <span class="n">scenario_config</span><span class="o">.</span><span class="n">scenario_name</span><span class="p">,</span> <span class="n">bulk</span> <span class="o">=</span> <span class="n">run_config</span><span class="o">.</span><span class="n">data_check_bulk_insert</span><span class="p">)</span>

        <span class="c1"># Pass inputs through scenario DB</span>
        <span class="k">if</span> <span class="n">run_config</span><span class="o">.</span><span class="n">insert_inputs_in_db</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_inputs_in_db</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">run_config</span><span class="p">,</span> <span class="n">scenario_config</span><span class="o">.</span><span class="n">scenario_name</span><span class="p">)</span>

        <span class="c1"># Run DO engine.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Solving </span><span class="si">{</span><span class="n">scenario_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># inputs = inputs_from_db if db_insert_input_flag else inputs</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">run_config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">run_config</span><span class="o">.</span><span class="n">enable_data_check_outputs</span><span class="p">:</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_check_outputs</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span> <span class="n">scenario_name</span><span class="o">=</span><span class="n">scenario_config</span><span class="o">.</span><span class="n">scenario_name</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="n">run_config</span><span class="o">.</span><span class="n">data_check_bulk_insert</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">run_config</span><span class="o">.</span><span class="n">insert_outputs_in_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_outputs_in_db</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">run_config</span><span class="p">,</span> <span class="n">scenario_config</span><span class="o">.</span><span class="n">scenario_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">run_config</span><span class="o">.</span><span class="n">insert_in_do</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_in_do</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">scenario_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">run_config</span><span class="o">.</span><span class="n">write_output_to_excel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_output_data_to_excel</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">scenario_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done with </span><span class="si">{</span><span class="n">scenario_config</span><span class="o">.</span><span class="n">scenario_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outputs</span>

<div class="viewcode-block" id="ScenarioRunner.create_new_db_schema"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioRunner.create_new_db_schema">[docs]</a>    <span class="k">def</span> <span class="nf">create_new_db_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Creating a new schema: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scenario_db_manager</span><span class="o">.</span><span class="n">create_schema</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_load_base_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excel_file_name</span><span class="p">,</span> <span class="n">base_inputs</span><span class="p">):</span>
        <span class="c1"># Load base inputs</span>
        <span class="k">if</span> <span class="n">excel_file_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">base_inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading data from the excel file&#39;</span><span class="p">)</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_input_data_from_excel</span><span class="p">(</span><span class="n">excel_file_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">excel_file_name</span> <span class="ow">and</span> <span class="n">base_inputs</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">base_inputs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Either base_inputs or excel_file_name should be provided.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputs</span>

    <span class="c1"># def run_once(self,</span>
    <span class="c1">#              scenario_config: ScenarioConfig,</span>
    <span class="c1">#              run_config: RunConfig,</span>
    <span class="c1">#              base_inputs: Optional[Inputs] = None,</span>
    <span class="c1">#              excel_file_name: Optional[str] = None) -&gt; Outputs:</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     :param scenario_config:</span>
    <span class="c1">#     :param run_config:</span>
    <span class="c1">#     :param base_inputs:</span>
    <span class="c1">#     :param excel_filepath</span>
    <span class="c1">#     :return:</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#</span>
    <span class="c1">#     scenario_name = scenario_config.scenario_name</span>
    <span class="c1">#     db_insert_input_flag = run_config.insert_inputs_in_db</span>
    <span class="c1">#     db_insert_output_flag = run_config.insert_outputs_in_db</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     Read data from the excel file. Either use `ScenarioInputsOutputs` class</span>
    <span class="c1">#     or `ScenarioManager.load_data_from_excel`.</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#</span>
    <span class="c1">#     # Load base inputs</span>
    <span class="c1">#     if excel_file_name and not base_inputs:</span>
    <span class="c1">#         self._logger.info(&#39;Loading data from the excel file&#39;)</span>
    <span class="c1">#         inputs = self.load_input_data_from_excel(excel_file_name)</span>
    <span class="c1">#     elif not excel_file_name and base_inputs:</span>
    <span class="c1">#         inputs = base_inputs</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         raise ValueError(</span>
    <span class="c1">#             &#39;Either base_inputs or excel_file_name should be provided.&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#     # Generate scenario</span>
    <span class="c1">#     self._logger.info(f&#39;Generating scenario {scenario_name}&#39;)</span>
    <span class="c1">#     inputs = self.generate_scenario(inputs, scenario_config)</span>
    <span class="c1">#</span>
    <span class="c1">#     # Data check</span>
    <span class="c1">#     if run_config.enable_data_check:</span>
    <span class="c1">#         inputs = self.data_check_inputs(inputs, scenario_name = scenario_config.scenario_name, bulk = run_config.data_check_bulk_insert)</span>
    <span class="c1">#</span>
    <span class="c1">#     # Pass inputs through scenario DB</span>
    <span class="c1">#     if run_config.insert_inputs_in_db:</span>
    <span class="c1">#         inputs = self.insert_inputs_in_db(inputs, run_config, scenario_config.scenario_name)</span>
    <span class="c1">#</span>
    <span class="c1">#     # Run DO engine.</span>
    <span class="c1">#     self._logger.info(f&#39;Solving {scenario_name}&#39;)</span>
    <span class="c1">#     # inputs = inputs_from_db if db_insert_input_flag else inputs</span>
    <span class="c1">#     outputs = self.run_model(inputs, run_config)</span>
    <span class="c1">#</span>
    <span class="c1">#     if run_config.enable_data_check_outputs:</span>
    <span class="c1">#         inputs, outputs = self.data_check_outputs(inputs=inputs, outputs=outputs, scenario_name=scenario_config.scenario_name, bulk=run_config.data_check_bulk_insert)</span>
    <span class="c1">#</span>
    <span class="c1">#     if run_config.insert_outputs_in_db:</span>
    <span class="c1">#         self.insert_outputs_in_db(inputs, outputs, run_config, scenario_config.scenario_name)</span>
    <span class="c1">#</span>
    <span class="c1">#     if run_config.insert_in_do:</span>
    <span class="c1">#         self.insert_in_do(inputs, outputs, scenario_config, self.model_name)</span>
    <span class="c1">#</span>
    <span class="c1">#     if run_config.write_output_to_excel:</span>
    <span class="c1">#         self.write_output_data_to_excel(inputs, outputs, scenario_name)</span>
    <span class="c1">#</span>
    <span class="c1">#     self._logger.info(f&#39;Done with {scenario_config.scenario_name}&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#     return outputs</span>

<div class="viewcode-block" id="ScenarioRunner.load_input_data_from_excel"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioRunner.load_input_data_from_excel">[docs]</a>    <span class="k">def</span> <span class="nf">load_input_data_from_excel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excel_file_name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Inputs</span><span class="p">:</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">ScenarioManager</span><span class="p">(</span><span class="n">local_root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_root</span><span class="p">,</span> <span class="n">local_relative_data_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                             <span class="n">data_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_directory</span><span class="p">,</span>
                             <span class="c1"># model_name=self.do_model_name,</span>
                             <span class="c1"># scenario_name=scenario_name,</span>
                             <span class="c1"># template_scenario_name=&#39;TemplateScenario&#39;,</span>
                             <span class="n">platform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_platform</span><span class="p">)</span>
        <span class="n">inputs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">load_data_from_excel</span><span class="p">(</span><span class="n">excel_file_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputs</span></div>

<div class="viewcode-block" id="ScenarioRunner.write_output_data_to_excel"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioRunner.write_output_data_to_excel">[docs]</a>    <span class="k">def</span> <span class="nf">write_output_data_to_excel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">:</span> <span class="n">Outputs</span><span class="p">,</span> <span class="n">scenario_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">ScenarioManager</span><span class="p">(</span><span class="n">local_root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_root</span><span class="p">,</span> <span class="n">local_relative_data_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                             <span class="n">data_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_directory</span><span class="p">,</span>
                             <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
                             <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_model_name</span><span class="p">,</span>
                             <span class="n">scenario_name</span><span class="o">=</span><span class="n">scenario_name</span><span class="p">,</span>
                             <span class="n">platform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_platform</span><span class="p">)</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">write_data_to_excel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wrote output to </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ScenarioRunner.generate_scenario"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioRunner.generate_scenario">[docs]</a>    <span class="k">def</span> <span class="nf">generate_scenario</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_inputs</span><span class="p">:</span> <span class="n">Inputs</span><span class="p">,</span>
                          <span class="n">scenario_config</span><span class="p">:</span> <span class="n">ScenarioConfig</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a derived scenario from a baseline scenario on the </span>
<span class="sd">        specifications in the scenario_config.</span>
<span class="sd">        :param base_inputs:</span>
<span class="sd">        :param scenario_config:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_generator_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generate Scenario&#39;</span><span class="p">)</span>
            <span class="n">sg</span><span class="p">:</span> <span class="n">ScenarioGenerator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_generator_class</span><span class="p">(</span><span class="n">base_inputs</span><span class="p">,</span> <span class="n">scenario_config</span><span class="p">)</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">sg</span><span class="o">.</span><span class="n">generate_scenario</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">base_inputs</span>
        <span class="k">return</span> <span class="n">inputs</span></div>

<div class="viewcode-block" id="ScenarioRunner.data_check_inputs"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioRunner.data_check_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">data_check_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Inputs</span><span class="p">,</span> <span class="n">scenario_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;data_check&#39;</span><span class="p">,</span> <span class="n">bulk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Inputs</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Use SQLite to validate data. Read data back and do a dm.prepare_data_frames.</span>
<span class="sd">        Does a deepcopy of the inputs to ensure the DB operations do not alter the inputs.</span>
<span class="sd">        Bulk can be set to True once the basic data issues have been resolved and performance needs to be improved.</span>
<span class="sd">        Set bulk to False to get more granular DB insert errors, i.e. per record.</span>
<span class="sd">        TODO: add a data_check() on the DataManager for additional checks.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Checking input data via SQLite and DataManager&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlite_scenario_db_manager</span><span class="p">:</span> <span class="n">ScenarioDbManager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_db_manager_class</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlite_scenario_db_manager</span><span class="o">.</span><span class="n">create_schema</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlite_scenario_db_manager</span><span class="o">.</span><span class="n">replace_scenario_in_db</span><span class="p">(</span><span class="n">scenario_name</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span> <span class="p">{},</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>

        <span class="n">inputs_v2</span><span class="p">,</span> <span class="n">outputs_v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlite_scenario_db_manager</span><span class="o">.</span><span class="n">read_scenario_from_db</span><span class="p">(</span><span class="n">scenario_name</span><span class="p">)</span>
        <span class="n">dm</span><span class="p">:</span> <span class="n">DataManager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_manager_class</span><span class="p">(</span><span class="n">inputs_v2</span><span class="p">,</span> <span class="n">outputs_v2</span><span class="p">)</span>
        <span class="n">dm</span><span class="o">.</span><span class="n">prepare_data_frames</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">inputs_v2</span></div>

<div class="viewcode-block" id="ScenarioRunner.data_check_outputs"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioRunner.data_check_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">data_check_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">:</span> <span class="n">Outputs</span><span class="p">,</span> <span class="n">scenario_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;data_check&#39;</span><span class="p">,</span> <span class="n">bulk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Inputs</span><span class="p">,</span> <span class="n">Outputs</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Use SQLite to validate data. Read data back and do a dm.prepare_data_frames.</span>
<span class="sd">        Does a deepcopy of the inputs to ensure the DB operations do not alter the inputs.</span>
<span class="sd">        Bulk can be set to True once the basic data issues have been resolved and performance needs to be improved.</span>
<span class="sd">        Set bulk to False to get more granular DB insert errors, i.e. per record.</span>
<span class="sd">        TODO: add a data_check() on the DataManager for additional checks.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Checking output data via SQLite and DataManager&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlite_scenario_db_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlite_scenario_db_manager</span><span class="p">:</span> <span class="n">ScenarioDbManager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_db_manager_class</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlite_scenario_db_manager</span><span class="o">.</span><span class="n">create_schema</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlite_scenario_db_manager</span><span class="o">.</span><span class="n">replace_scenario_in_db</span><span class="p">(</span><span class="n">scenario_name</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">outputs</span><span class="p">),</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlite_scenario_db_manager</span><span class="o">.</span><span class="n">update_scenario_output_tables_in_db</span><span class="p">(</span><span class="n">scenario_name</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>  <span class="c1"># TODO: add bulk=False option</span>

        <span class="n">inputs_v2</span><span class="p">,</span> <span class="n">outputs_v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlite_scenario_db_manager</span><span class="o">.</span><span class="n">read_scenario_from_db</span><span class="p">(</span><span class="n">scenario_name</span><span class="p">)</span>
        <span class="n">dm</span><span class="p">:</span> <span class="n">DataManager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_manager_class</span><span class="p">(</span><span class="n">inputs_v2</span><span class="p">,</span> <span class="n">outputs_v2</span><span class="p">)</span>
        <span class="n">dm</span><span class="o">.</span><span class="n">prepare_data_frames</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">inputs_v2</span><span class="p">,</span> <span class="n">outputs_v2</span></div>

<div class="viewcode-block" id="ScenarioRunner.insert_inputs_in_db"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioRunner.insert_inputs_in_db">[docs]</a>    <span class="k">def</span> <span class="nf">insert_inputs_in_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Inputs</span><span class="p">,</span> <span class="n">run_config</span><span class="p">:</span> <span class="n">RunConfig</span><span class="p">,</span> <span class="n">scenario_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Inputs</span><span class="p">:</span>

        <span class="c1"># 1. Create new schema: Is NOT done here! Is now done earlier and only once per call</span>
        <span class="c1"># 2. Insert inputs in DB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scenario_db_manager</span><span class="o">.</span><span class="n">replace_scenario_in_db</span><span class="p">(</span><span class="n">scenario_name</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="p">{},</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># 3. Read inputs from DB</span>
        <span class="n">inputs_v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_db_manager</span><span class="o">.</span><span class="n">read_scenario_input_tables_from_db</span><span class="p">(</span><span class="n">scenario_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputs_v2</span></div>

    <span class="c1"># def insert_inputs_in_db(self, inputs: Inputs, run_config: RunConfig, scenario_name: str) -&gt; Inputs:</span>
    <span class="c1">#</span>
    <span class="c1">#     # 1. Create new schema</span>
    <span class="c1">#     if run_config.new_schema:</span>
    <span class="c1">#         self._logger.info(f&#39;Creating a new schema: {self.schema}&#39;)</span>
    <span class="c1">#         self.scenario_db_manager.create_schema()</span>
    <span class="c1">#     # 2. Insert inputs in DB</span>
    <span class="c1">#     self.scenario_db_manager.replace_scenario_in_db(scenario_name, inputs, {}, bulk=True)</span>
    <span class="c1">#     # 3. Read inputs from DB</span>
    <span class="c1">#     inputs_v2 = self.scenario_db_manager.read_scenario_input_tables_from_db(scenario_name)</span>
    <span class="c1">#     return inputs_v2</span>


<div class="viewcode-block" id="ScenarioRunner.run_model"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioRunner.run_model">[docs]</a>    <span class="k">def</span> <span class="nf">run_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Inputs</span><span class="p">,</span> <span class="n">run_config</span><span class="p">:</span> <span class="n">RunConfig</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Main method to run the optimization model.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_manager_class</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">run_config</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>  <span class="c1"># &#39;DEBUG&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_engine</span><span class="p">:</span> <span class="n">OptimizationEngine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_engine_class</span><span class="p">(</span>
            <span class="n">data_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="n">run_config</span><span class="o">.</span><span class="n">do_model_name</span> <span class="k">if</span> <span class="n">run_config</span><span class="o">.</span><span class="n">do_model_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_model_name</span><span class="p">),</span>
            <span class="n">export_lp</span><span class="o">=</span><span class="n">run_config</span><span class="o">.</span><span class="n">export_lp</span><span class="p">,</span>
            <span class="n">export_sav</span><span class="o">=</span><span class="n">run_config</span><span class="o">.</span><span class="n">export_sav</span><span class="p">,</span>
            <span class="n">export_lp_path</span><span class="o">=</span><span class="n">run_config</span><span class="o">.</span><span class="n">export_lp_path</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_engine</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="ScenarioRunner.insert_outputs_in_db"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioRunner.insert_outputs_in_db">[docs]</a>    <span class="k">def</span> <span class="nf">insert_outputs_in_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">:</span> <span class="n">Outputs</span><span class="p">,</span> <span class="n">run_config</span><span class="p">:</span> <span class="n">RunConfig</span><span class="p">,</span> <span class="n">scenario_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Inserting outputs into the database&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">run_config</span><span class="o">.</span><span class="n">insert_inputs_in_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scenario_db_manager</span><span class="o">.</span><span class="n">update_scenario_output_tables_in_db</span><span class="p">(</span><span class="n">scenario_name</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scenario_db_manager</span><span class="o">.</span><span class="n">replace_scenario_in_db</span><span class="p">(</span><span class="n">scenario_name</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ScenarioRunner.insert_in_do"><a class="viewcode-back" href="../../dse_do_utils.html#dse_do_utils.scenariorunner.ScenarioRunner.insert_in_do">[docs]</a>    <span class="k">def</span> <span class="nf">insert_in_do</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">scenario_config</span><span class="p">:</span> <span class="n">ScenarioConfig</span><span class="p">,</span>
                     <span class="n">run_config</span><span class="p">:</span> <span class="n">RunConfig</span><span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DO insert for </span><span class="si">{</span><span class="n">scenario_config</span><span class="o">.</span><span class="n">scenario_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">ScenarioManager</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">run_config</span><span class="o">.</span><span class="n">do_model_name</span><span class="p">,</span>
                             <span class="n">scenario_name</span><span class="o">=</span><span class="n">scenario_config</span><span class="o">.</span><span class="n">scenario_name</span><span class="p">)</span>
        <span class="c1"># sm.inputs = inputs</span>
        <span class="c1"># sm.outputs = outputs</span>
        <span class="c1"># self._logger.info(f&#39;Scenario: {scenario_config.scenario_name}&#39;)</span>
        <span class="c1"># sm.print_table_names()</span>
        <span class="c1"># sm.write_data_into_scenario()</span>
        <span class="c1"># self._logger.info(&#39;Start create&#39;)</span>
        <span class="n">sm</span><span class="o">.</span><span class="n">write_data_into_scenario_s</span><span class="p">(</span>
            <span class="n">run_config</span><span class="o">.</span><span class="n">do_model_name</span><span class="p">,</span>
            <span class="n">scenario_config</span><span class="o">.</span><span class="n">scenario_name</span><span class="p">,</span>
            <span class="n">inputs</span><span class="p">,</span>
            <span class="n">outputs</span><span class="p">,</span>
            <span class="n">template_scenario_name</span><span class="o">=</span><span class="n">run_config</span><span class="o">.</span><span class="n">template_scenario_name</span><span class="p">)</span></div></div>
        <span class="c1"># sm.write_data_to_excel()</span>

    <span class="c1"># @staticmethod</span>
    <span class="c1"># def schema_exists(scdb: ScenarioDbManager, db_credentials: dict,</span>
    <span class="c1">#                   schema: str) -&gt; bool:</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     TODO: scdb already has a engine. No need to create a new one</span>
    <span class="c1">#     :param scdb:</span>
    <span class="c1">#     :param db_credentials:</span>
    <span class="c1">#     :param schema:</span>
    <span class="c1">#     :return:</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1">#     connection_string_list = scdb._get_db2_connection_string(</span>
    <span class="c1">#         db_credentials, schema).split(&#39;;&#39;)</span>
    <span class="c1">#     connection_string = (connection_string_list[0] + &#39;;&#39; +</span>
    <span class="c1">#                          connection_string_list[-1])</span>
    <span class="c1">#     engine = create_engine(connection_string, echo=True)</span>
    <span class="c1">#</span>
    <span class="c1">#     with engine.connect() as connection:</span>
    <span class="c1">#         result = connection.execute(</span>
    <span class="c1">#             text(f&#39;SELECT schemaname FROM syscat.schemata;&#39;))</span>
    <span class="c1">#</span>
    <span class="c1">#         for row in result:</span>
    <span class="c1">#             if row[0] == schema:</span>
    <span class="c1">#                 return True</span>
    <span class="c1">#</span>
    <span class="c1">#     return False</span>
    <span class="c1">#</span>
    <span class="c1"># def create_new_schema(self, db_credentials: Dict[str, str],</span>
    <span class="c1">#                       schema: str) -&gt; None:</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     Create a new schema if it does not exist.</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#</span>
    <span class="c1">#     scdb = ScenarioDbManager(echo=False,</span>
    <span class="c1">#                              credentials=db_credentials,</span>
    <span class="c1">#                              schema=schema)</span>
    <span class="c1">#</span>
    <span class="c1">#     if not ScenarioRunner.schema_exists(scdb, db_credentials, schema):</span>
    <span class="c1">#         scdb.create_schema()</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">DSE DO Utils 0.5.5.1b0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../dse_do_utils.html" >dse_do_utils</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">dse_do_utils.scenariorunner</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Victor Terpstra.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>